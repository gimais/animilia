{% extends "base.html" %}
{% block title %}{{ anime.name }} - Animilia{% endblock %}
{% block logout_redirect %}{{ request.path }}{% endblock %}
{% block description %}{{ anime.name }} - ქართულად გახმოვანებული{% endblock %}
{% block ogtitle %}<meta property="og:title" content="{{ anime.name }}"/>{% endblock %}
{% block ogdescription %}<meta property="og:description" content="Animilia.ge - ქართულად გახმოვანებული ფილმები და ანიმეები">{% endblock %}

{% block content %}
    <div class="container">
        <div class="item-page clearfix" data-id="{{ anime.id }}">
                <img class="item-page-img" src="/media/{{ anime.poster }}?r=1"  alt="სურათი არ არის">
            <div class="item-page-info">
                <div class="item-page-head clearfix">
                    <div class="item-page-left">
                        <h1>{{ anime.name }}</h1>
                        <h4> {{ anime.nameen }}</h4>
                        <h4> {{ anime.namejp }}</h4>
                        <h4> {{ anime.nameru }}</h4>
                    </div>
                    <div class="item-page-right">
                        <span><i class="fas fa-star"></i> {{ anime.rating }}</span>
                    </div>
                </div>
                <hr>
                <div class="item-page-row">
                    <dl>
                        <dt>ტიპი:</dt>
                        {% if anime.type == 0 %}
                            <dd>სერიალი</dd>
                        {% elif anime.type == 1 %}
                            <dd>ფილმი</dd>
                        {% endif %}
                        <dt>სტატუსი:</dt>
                        {% if anime.finished %}
                            <dd class="anime-status finished">გახმოვანებული</dd>
                        {% else%}
                            <dd class="anime-status not-finished">გახმოვანების პროცესში</dd>
                        {% endif %}
                        <dt>სტუდია:</dt>
                        <dd>{{ anime.studio }}</dd>
                        <dt>გამოშვების წელი:</dt>
                        <dd>{{ anime.year }}</dd>
                        <dt>ჟანრები:</dt>
                        <dd>
                            {% for genre in anime.categories.all %}
                                <li>{{ genre }}</li>
                            {% endfor %}
                        </dd>
                        <dt>ასაკობრივი შეზღუდვა:</dt>
                        <dd>{{ anime.age }}+</dd>
                        <dt>რეჟისორი:</dt>
                        <dd>{{ anime.director }}</dd>
                        {% if anime.type == 0 %}
                        <dt>სერიების რაოდენობა:</dt>
                        <dd>{{ anime.dubbed }}/{{anime.episodes}}</dd>
                        {% endif %}
                        <dt>გამხმოვანებელი:</dt>
                        <dd>
                            {% for dubber in anime.dubbers.all %}
                                <li>{{ dubber }}</li>
                            {% endfor %}
                        </dd>
                    </dl>
                </div>
            </div>
            <div class="item-page-desc">
                <p>{{anime.description}}</p>
            </div>
            <hr>
            {% if anime.type == 0 %}
            <div class="item-page-episodes">
                {% for episode in anime.series.all|dictsort:"row" %}
                <div class="episode-select-button" data-id="{{episode.row}}" data-url="{{episode.url}}">{{ episode.row }}</div>
                {% endfor %}
            </div>
            <div class="item-player hidden">
                <iframe frameborder="0" allowfullscreen="true"></iframe>
            </div>
            {% else %}
            <div class="item-player">
                {% with anime.series.all|first as episode %}
                    <iframe src="{{ episode.url }}" frameborder="0" allowfullscreen="true"></iframe>
                </video>
                {% endwith %}
            </div>
            {% endif %}
            <hr>
            {% include "anime/comments.html" %}
        </div>
    </div>
{% endblock %}

{% block script %}
    <script>
        {#var isMobile = (/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase()));#}

        var urlForQueryParams = new URL(window.location.href);

        if(urlForQueryParams.searchParams.has("parent")) {
            var parentId = urlForQueryParams.searchParams.get("parent");
            var commentBox = $('.reply-button[data-id=' + parentId + ']').parents('.comment');
            var commentRepliesCheck = commentBox.find('.comment-replies-check');

            if(commentBox.length) {
                $([document.documentElement, document.body]).animate({
                    scrollTop: commentBox.offset().top - 50
                }, 500, function () {
                    if(commentRepliesCheck.length)
                        getChildComments(commentRepliesCheck, commentRepliesCheck.data('id'));
                });
                if(commentRepliesCheck.length)
                    commentRepliesCheck.toggleClass('closed opened');
            }
            {% if deletedcomment %}
            else{
                var deletedObj = {
                    'deleted' : true,
                    'comment_id': {{ deletedcomment.comment_id }},
                    'user_id': {{ deletedcomment.user_id }},
                    'username': "{{ deletedcomment.username }}",
                    'avatar': "{{ deletedcomment.avatar }}",
                    'time': {{ deletedcomment.time }},
                    'childs_count':{{ deletedcomment.childs_count }},
                };
                var html = makeCommentBoxHTML(deletedObj);
                $(".comments-box").prepend(makeCommentBoxHTML(deletedObj));

                var commentBox = $('.comment-replies-check[data-id=' + parentId + ']');
                $([document.documentElement, document.body]).animate({
                    scrollTop: commentBox.parents('.comment').offset().top - 50
                }, 500, function () {
                    getChildComments(commentBox, parentId);
                });
            }
            {% endif %}
        }

        Array.prototype.forEach.call(document.getElementsByClassName('comment'), child => {
            var com = $(child).find('.comment-body').find('p');
            if(com.length > 2){
                com = com[2] // authorized
            }else{
                com = com[1] // nonauthorized
            }
            com.innerHTML = ifCommentContainsSpoiler(com.innerHTML.trim());
        });

    {% if anime.type == 0 %}
        var pageCookie = getCookie(itemSlug.substring(7,itemSlug.length-1));
        if (pageCookie !== "") {
            $('.item-page-episodes').find(`.episode-select-button[data-id=${pageCookie}]`).addClass('active');
        }
    {% endif %}
        if (getCookie("_vEpAd") === "") {
            setCookie("_vEpAd",cT(),1/24);
        }
    </script>
{% endblock %}